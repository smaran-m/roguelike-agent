type Mapping = ReadonlyArray<[string, string]>;

export class UnicodeMapper {
  // Primary curated mapping table.
  // (Roughly organized by category for easier maintenance)
private static readonly MAP: Mapping = [
    /* Faces & Mood */
    ['ğŸ˜€','ãƒ„'], ['ğŸ˜ƒ','â— '], ['ğŸ˜„','â—¡'], ['ğŸ˜','â‰§'], ['ğŸ˜†','â–½'],
    ['ğŸ˜…','ï¸¿'], ['ğŸ˜‚','â—'], ['ğŸ¤£','â—'], ['ğŸ™‚','ï½¡'], ['â˜ºï¸','â— '],
    ['ğŸ˜Š','â—¡'], ['ğŸ˜‰','ã‚'], ['ğŸ˜Œ','Ë˜'], ['ğŸ˜','â¤'], ['ğŸ˜˜','Ğ·'],
    ['ğŸ˜—','Ğ·'], ['ğŸ˜™','Ğ·'], ['ğŸ˜š','Ğ·'], ['ğŸ˜‹','á“'], ['ğŸ˜œ','ã‚œ'],
    ['ğŸ˜','á—§'], ['ğŸ˜›','á™ '], ['ğŸ¤‘','$'], ['ğŸ¤—','ã†…'], ['ğŸ¤­','âˆ'],
    ['ğŸ¤«','âˆ´'], ['ğŸ¤”','âˆµ'], ['ğŸ¤','âˆ¥'], ['ğŸ˜','â€”'], ['ğŸ˜‘','â”€'],
    ['ğŸ˜¶','â–¡'], ['ğŸ™„','â—”'], ['ğŸ˜','Â¬'], ['ğŸ˜’','ï¹€'], ['ğŸ˜¬','â‰‹'],
    ['ğŸ¤¥','â‰‰'], ['ğŸ˜”','ï¹–'], ['ğŸ˜•','ï¹‚'], ['ğŸ™ƒ','âˆ©'], ['ğŸ˜´','Z'],
    ['ğŸ˜ª','â€¦'], ['ğŸ˜®','Ã¶'], ['ğŸ˜¯','Ã–'], ['ğŸ˜²','â›£'], ['ğŸ˜³','ê™¬'],
    ['ğŸ˜±','ğ“‚€'], ['ğŸ˜¨','á›'], ['ğŸ˜°','á‘’'], ['ğŸ˜¥','ï¹¢'], ['ğŸ˜¢','à²¥'],
    ['ğŸ˜­','à²¥'], ['ğŸ˜¤','á•¦'], ['ğŸ˜¡','â€¼'], ['ğŸ˜ ','ï¼'], ['ğŸ¤¯','â€»'],
    ['ğŸ¤ª','â—'], ['ğŸ˜·','â–­'], ['ğŸ¤’','Â°'], ['ğŸ¤•','âŠ“'], ['ğŸ¤¢','â‰ˆ'],
    ['ğŸ¤®','âˆ¿'], ['ğŸ¤§','ã€°'], ['ğŸ˜‡','âœ§'], ['ğŸ¤ ','^'], ['ğŸ¤“','âŒ'],
    ['ğŸ« ','âˆ‡'],


    /* Cats & Monsters & Skulls */
    ['ğŸ˜º','ğ“ƒ '], ['ğŸ˜¸','Ï‰'], ['ğŸ˜¹','à²¥'], ['ğŸ˜»','â¤'], ['ğŸ˜¼','Â¬'],
    ['ğŸ˜½','Ğ·'], ['ğŸ™€','ğ“¹'], ['ğŸ˜¿','à²¥'], ['ğŸ˜¾','â‰–'],
    ['ğŸ‘»', 'à²”'], ['ğŸ‘½', 'â™¾'], ['ğŸ‘¾', 'ê¤'], ['ğŸ¤–', 'ğ‡'], ['ğŸ’©', 'ê™®'],
    ['ğŸ’€', 'â˜ '], ['â˜ ï¸', 'â˜ '], ['ğŸ˜ˆ', 'âš‰'], ['ğŸ‘¿', 'ã€ '], ['ğŸ‘¹', 'ã€ '], ['ğŸ‘º', 'ã€ '],

    /* Hands & Gestures */
    ['ğŸ‘', 'âœ“'], ['ğŸ‘', 'âœ—'], ['ğŸ‘Œ', 'â—‹'], ['âœŒï¸', 'V'], ['ğŸ¤', 'X'],
    ['ğŸ¤Ÿ', 'Y'], ['ğŸ¤˜', 'ÊŒ'], ['ğŸ¤™', 'âˆª'], ['ğŸ‘Š', 'â—'], ['âœŠ', 'â– '],
    ['ğŸ‘', 'âˆ¥'], ['ğŸ™', 'âˆ©'], ['ğŸ¤', 'â‰¡'], ['âœï¸', 'âœ'], ['ğŸ«¶', 'âˆ©'],
    ['ğŸ‘‰', 'â†’'], ['ğŸ‘ˆ', 'â†'], ['ğŸ‘†', 'â†‘'], ['ğŸ‘‡', 'â†“'], ['â˜ï¸', 'â†‘'],

    /* Hearts & Stars & Symbols */
    ['â¤ï¸', 'â‹†'], ['ğŸ’›', 'â‹†'], ['ğŸ’š', 'â‹†'], ['ğŸ’™', 'â‹†'], ['ğŸ’œ', 'â‹†'],
    ['ğŸ–¤', 'â‹†'], ['ğŸ¤', 'â‹†'], ['ğŸ¤', 'â‹†'], ['â£ï¸', 'â‹†'], ['ğŸ’˜', 'â‹†'],
    ['ğŸ’', 'â‹†'], ['ğŸ’–', 'â‹„'], ['ğŸ’—', 'â‹„'], ['ğŸ’“', 'â‹„'], ['ğŸ’', 'â‹„'],
    ['ğŸ’«', 'â‹„'], ['âœ¨', 'â‹„'], ['â­', 'â‹†'], ['ğŸŒŸ', 'â‹†'], ['ğŸ’¥', 'âˆ—'],
    ['ğŸ”¥', 'âˆ†'], ['âš¡', 'â†¯'], ['ğŸ’¯', ''], ['ğŸ’¢', 'â€¼'], ['â—', '!'],
    ['â€¼ï¸', '!!'], ['â“', '?'], ['â•', '!'], ['â”', '?'], ['â‰ï¸', '!?'],
    ['â­•', 'â—¯'], ['âœ…', 'âœ“'], ['â˜‘ï¸', 'â˜‘'], ['âœ”ï¸', 'âœ“'], ['âŒ', 'Ã—'],
    ['â•', '+'], ['â–', 'âˆ’'], ['â—', 'Ã·'], ['â°', 'â—Œ'], ['â¿', 'á€‘'],
    ['âœ³ï¸', '*'], ['âœ´ï¸', '*'], ['â„¢ï¸', 'â„¢'], ['Â©ï¸', 'Â©'], ['Â®ï¸', 'Â®'],
    ['ã€½ï¸', 'ã€½'], ['â–ªï¸', 'â– '], ['â–«ï¸', 'â–¡'], ['â—¾', 'â– '], ['â—½', 'â–¡'],
    ['â—¼ï¸', 'â– '], ['â—»ï¸', 'â–¡'], ['â—¯', 'â—¯'], ['â¬›', 'â–ˆ'], ['â¬œ', 'â–‘'],
    ['ğŸ”´', 'â—'], ['ğŸŸ ', 'â—'], ['ğŸŸ¡', 'â—'], ['ğŸŸ¢', 'â—'], ['ğŸ”µ', 'â—'],
    ['ğŸŸ£', 'â—'], ['âš«', 'â—'], ['âšª', 'â—‹'],

    /* Weather & Nature */
    ['â˜€ï¸', 'âŠ™'], ['ğŸŒ¤ï¸', 'âŠ™'], ['â›…', 'â‰‹'], ['â˜ï¸', 'â‰‹'], ['ğŸŒ§ï¸', 'â‰‹'],
    ['â›ˆï¸', 'â†¯'], ['ğŸŒ©ï¸', 'â†¯'], ['ğŸŒªï¸', 'âŠ—'], ['ğŸŒ«ï¸', 'â‰ˆ'], ['ğŸŒ¨ï¸', 'âœ±'],
    ['â„ï¸', 'âœ±'], ['â˜ƒï¸', 'â§ˆ'], ['â˜”', 'Y'], ['ğŸ’§', 'ï¹¢'], ['ğŸ’¦', 'ï¹¢'],
    ['ğŸŒˆ', '~'], ['ğŸŒ™', 'â—‘'], ['ğŸŒ', 'â—•'], ['ğŸŒ', 'â—•'], ['ğŸŒš', 'â—‘'],
    ['ğŸŒ‘', 'â—'], ['ğŸŒ“', 'â—'], ['ğŸŒ—', 'â—‘'], ['ğŸŒ•', 'â—‹'], ['ğŸŒ–', 'â—“'],
    ['ğŸŒ”', 'â—’'], ['ğŸŒ’', 'â—“'], ['ğŸŒ˜', 'â—’'], ['â­ï¸', 'â‹†'],

    /* Animals â€” swap many to zodiac/chess/math/latin to avoid CJK */
    ['ğŸ¦','ğ“ƒ­'], ['ğŸ®','ğ“ƒ¾'], ['ğŸ‚','ğ“ƒ—'], ['ğŸ„','ğ“ƒ¾'], ['ğŸ','ğ“ƒµ'], ['ğŸ','ğ“ƒ¶'],
    ['ğŸ´','â™'], ['ğŸ¦„','ğ‚ƒ'], ['ğŸ¦€','â™‹'], ['ğŸŸ','ğ“†Ÿ'], ['ğŸ ','ğ“†'], ['ğŸ¡','ğ“†'],
    ['ğŸ¦‚','ğ‚¥'], ['ğŸ','àºª'], ['ğŸ¢','ğ“†‰'], ['ğŸ¦','ğ“…ƒ'], ['ğŸ§','ğ“…±'],
    ['ğŸ•Šï¸','ğ“…ƒ'], ['ğŸ¶','Ê˜'], ['ğŸº','Î›'], ['ğŸ±','ğ“ƒ '], ['ğŸ­','Â°'],
    ['ğŸ¹','Â°'], ['ğŸ°','ğ“ƒ¹'], ['ğŸ»','á´¥'], ['ğŸ¼','á´¥'], ['ğŸ¨','áµœ'],
    ['ğŸ¯','ğ“ƒ­'], ['ğŸ·','Â¤'], ['ğŸ¸','ğ“†ˆ'], ['ğŸµ','ğ“ƒ»'], ['ğŸ”','ğ“…«'],

    /* Food & Drink (geometric & symbols) */
    ['ğŸ', 'â—'], ['ğŸ', 'â—'], ['ğŸ', 'â—'], ['ğŸŠ', 'â—'], ['ğŸ‹', 'â—'],
    ['ğŸŒ', 'âˆª'], ['ğŸ‰', 'â—™'], ['ğŸ‡', 'â—™'], ['ğŸ“', 'â—ˆ'], ['ğŸ’', 'â—ˆ'],
    ['ğŸ‘', 'â—–'], ['ğŸ', 'âœ³'], ['ğŸ¥­', 'â—'], ['ğŸ¥¥', 'â—Œ'], ['ğŸ¥', 'â—'],
    ['ğŸ…', 'â—'], ['ğŸ¥”', 'â—‹'], ['ğŸ¥•', 'âˆ§'], ['ğŸŒ½', 'â‰¡'], ['ğŸ¥’', 'ä¸¨'],
    ['ğŸ¥¬', 'â‰€'], ['ğŸ¥¦', 'â‰€'], ['ğŸ§„', 'â‰€'], ['ğŸ§…', 'â‰€'], ['ğŸ', 'â–­'],
    ['ğŸ¥', 'âˆ©'], ['ğŸ¥–', 'ä¸¨'], ['ğŸ¥¯', 'â—¯'], ['ğŸ¥', 'â‰¡'], ['ğŸ§‡', 'â–’'],
    ['ğŸ§€', 'â–­'], ['ğŸ—', 'âˆ©'], ['ğŸ–', 'âŠ“'], ['ğŸ”', 'â–£'], ['ğŸŸ', 'â‰¡'],
    ['ğŸ•', 'â–³'], ['ğŸŒ­', 'âŠ”'], ['ğŸ¥ª', 'â–­'], ['ğŸŒ®', 'â— '], ['ğŸŒ¯', 'â—§'],
    ['ğŸœ', 'ã€¼'], ['ğŸ£', 'ã€“'], ['ğŸ¤', 'ã¤'], ['ğŸ™', 'â—‰'], ['ğŸš', 'â—Œ'],
    ['ğŸ˜', 'â—'], ['ğŸ¥', 'â—'], ['ğŸ¡', 'â—'], ['ğŸ§', 'âˆ§'], ['ğŸ¨', 'âˆ©'],
    ['ğŸ©', 'â—¯'], ['ğŸª', 'â—Œ'], ['ğŸ«', 'â–¦'], ['ğŸ¬', 'â—‡'], ['ğŸ­', 'â—'],
    ['ğŸ®', 'â–¤'], ['ğŸ¯', 'âˆµ'], ['ğŸ¼', 'Â¡'], ['â˜•', 'ğƒ´'], ['ğŸµ', 'â›¾'],
    ['ğŸº', '!'], ['ğŸ»', 'â€¼'], ['ğŸ¥‚', 'â€¼'], ['ğŸ·', 'ğƒ¯'], ['ğŸ¸', 'ğƒ®'], ['ğŸ¹', 'Y'],

    /* Activities & Objects */
    ['âš½', 'â—‹'], ['ğŸ€', 'â—¯'], ['ğŸˆ', 'â—‰'], ['âš¾', 'â—'], ['ğŸ¾', 'â—Œ'],
    ['ğŸ', 'â—¯'], ['ğŸ‰', 'â—‰'], ['ğŸ±', 'â—'], ['ğŸ“', 'â—Œ'], ['ğŸ¸', 'Y'],
    ['ğŸ¥Š', 'â–£'], ['ğŸ¥‹', 'å‡¸'], ['ğŸ½', 'ğ‡'], ['ğŸ›¹', 'â–­'], ['â›³', 'â€ '],
    ['ğŸ£', 'J'], ['ğŸ³', 'â—'], ['ğŸ¯', 'âŠ•'], ['ğŸ®', 'â˜'], ['ğŸ°', 'â‰¡'], ['ğŸ²', 'â– '],
    ['ğŸ§©', 'â–£'], ['â™Ÿï¸', 'â™Ÿ'], ['ğŸº', 'J'], ['ğŸ·', 'J'], ['ğŸ¸', 'Êƒ'], ['ğŸ»', 'Êƒ'],
    ['ğŸ¹', 'â™®'], ['ğŸ¼', 'â™©'], ['ğŸµ', 'â™ª'], ['ğŸ¶', 'â™«'], ['ğŸ¤', 'â€ '],

    /* Travel & Places (no swastikas; symbolic alternates) */
    ['ğŸš—', 'â–£'], ['ğŸš•', 'â–£'], ['ğŸš™', 'â–£'], ['ğŸšŒ', 'â–¤'], ['ğŸš', 'â–¤'],
    ['ğŸï¸', 'â–£'], ['ğŸš“', 'â–£'], ['ğŸš‘', 'â–£'], ['ğŸš’', 'â–£'], ['ğŸš', 'â–¤'],
    ['ğŸšš', 'â–¤'], ['ğŸš›', 'â–¤'], ['ğŸšœ', 'â–¤'], ['ğŸ›´', 'â–­'], ['ğŸš²', 'âŠ‚'],
    ['ğŸ›µ', 'âŠ‚'], ['ğŸï¸', 'âŠ‚'], ['ğŸš¨', '!'], ['ğŸš¥', 'âˆ´'], ['ğŸš¦', 'âˆ´'],
    ['ğŸš§', 'âˆ'], ['â›½', 'âŸŸ'], ['ğŸš', 'âŠ“'], ['ğŸ—ºï¸', 'â–¦'], ['ğŸ—¿', 'â– '],
    ['ğŸ—¼', 'â€ '], ['ğŸ—½', 'Â¶'], ['â›©ï¸', 'â›©'], ['â›²', 'â‰‹'], ['ğŸ°', 'â™œ'],
    ['ğŸ¯', 'â™œ'], ['ğŸ ', 'âŒ‚'], ['ğŸ¡', 'âŒ‚'], ['ğŸ¢', 'Ê­'], ['ğŸ£', 'ã€’'],
    ['ğŸ¤', 'â›«'], ['ğŸ¥', 'âœš'], ['ğŸ¦', 'Â¤'], ['ğŸ«', 'âˆ‘'], ['ğŸª', 'â–¥'],
    ['ğŸ¬', 'â–¥'], ['ğŸ­', 'âš™'], ['ğŸ›ï¸', 'âˆ'], ['â›ª', 'â€ '], ['ğŸ•Œ', 'â˜ª'],
    ['ğŸ•', 'âœ¡'], ['ğŸ•‹', 'â–¡'], ['ğŸ›•', 'à¥'], ['â›º', 'â–³'],

    /* Tools & UI Symbols */
    ['ğŸ”', 'âŠ•'], ['ğŸ”', 'âŠ–'], ['ğŸ”§', 'âŠ©'], ['ğŸ”¨', 'âŠ¢'], ['ğŸª“', 'âŠ£'],
    ['â›ï¸', 'âŠ¡'], ['âš’ï¸', 'âŠ¤'], ['ğŸ› ï¸', 'âŠ¥'], ['ğŸ—¡ï¸', 'â€ '], ['âš”ï¸', 'â€¡'],
    ['ğŸ¹', 'â†¤'], ['ğŸ›¡ï¸', 'âŸ'], ['ğŸ”—', 'âˆ½'], ['â›“ï¸', 'âˆ¿'], ['âš™ï¸', 'âš™'], ['ğŸ§­', 'âœš'],
    ['â°', 'â°'], ['â±ï¸', 'â±'], ['â²ï¸', 'â²'], ['â³', 'âŒ›'], ['âŒ›', 'âŒ›'],
    ['âŒš', 'âŒš'], ['ğŸ”’', 'âŠ˜'], ['ğŸ”“', 'âŠ–'], ['ğŸ”‘', 'ÏŸ'], ['ğŸ—ï¸', 'ÏŸ'],
    ['âœ‰ï¸', 'â‰œ'], ['ğŸ“©', 'â‰œ'], ['ğŸ“§', '@'], ['ğŸ“', 'T'], ['â˜ï¸', 'T'],
    ['ğŸ“±', 'â–¥'], ['ğŸ’»', 'â–¦'], ['âŒ¨ï¸', 'âŒ¨'], ['ğŸ–±ï¸', 'â€¢'], ['ğŸ–²ï¸', 'â€¢'],
    ['ğŸ’½', 'â—§'], ['ğŸ’¾', 'â–¨'], ['ğŸ’¿', 'â—'], ['ğŸ“€', 'â—'], ['ğŸ–¨ï¸', 'â–¦'],
    ['ğŸ–¥ï¸', 'â–¦'], ['ğŸ—‚ï¸', 'â‰£'], ['ğŸ—ƒï¸', 'â‰£'], ['ğŸ—„ï¸', 'â‰£'],
    ['ğŸ“‚', 'â‰£'], ['ğŸ“', 'â‰£'], ['ğŸ“', 'â‰”'], ['âœï¸', 'âœ'], ['âœ’ï¸', 'âœ'],
    ['ğŸ–Šï¸', 'âœ'], ['ğŸ–‹ï¸', 'âœ'], ['ğŸ–Œï¸', 'ä¸¿'], ['ğŸ–ï¸', 'âˆ•'], ['ğŸ“Œ', 'â€ '],
    ['ğŸ“', 'â€¢'], ['ğŸ“', 'âˆª'], ['ğŸ–‡ï¸', 'âˆ©'], ['ğŸ“', 'âˆ '], ['ğŸ“', 'â€”'],

    /* People silhouettes â†’ Egyptian man (generic pictograph) */
    ['ğŸ‘¤', 'ğ“€€'], ['ğŸ‘¥', 'ğ“€€'],

    /* Numbers & Keycaps */
    ['0ï¸âƒ£', '0'], ['1ï¸âƒ£', '1'], ['2ï¸âƒ£', '2'], ['3ï¸âƒ£', '3'], ['4ï¸âƒ£', '4'],
    ['5ï¸âƒ£', '5'], ['6ï¸âƒ£', '6'], ['7ï¸âƒ£', '7'], ['8ï¸âƒ£', '8'], ['9ï¸âƒ£', '9'],
    ['ğŸ”Ÿ', '10'],

    /* Simple ZWJ sequences (collapsed) */
    ['ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', 'â‰¡'], ['ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', 'â‰¡'], ['ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', 'â‰¡'], ['ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦', 'â‰¡'],
  ] as const;

  // Variation Selectors and Modifiers we strip before replacement.
  private static readonly STRIP_REGEX = /[\uFE0E\uFE0F\u200D\u{1F3FB}-\u{1F3FF}]/gu;

  // Keycap combining character: turn "1\u20E3" into "1" etc.
  private static readonly KEYCAP_REGEX = /([0-9#*])\uFE0F?\u20E3/gu;

  // Build the internal map at load time, expanding with stripped variants.
  private static buildMap(): Map<string, string> {
    const m = new Map<string, string>();

    // Add base entries and their FE0F-stripped forms.
    for (const [src, dst] of this.MAP) {
      // Enforce that dst is outside popular emoji planes via simple range checks.
      // (Not exhaustive, but helps catch common mistakes.)
      const cp = dst.codePointAt(0)!;
      const isLikelyEmojiTarget =
        (cp >= 0x1F300 && cp <= 0x1FFFF) ||   // Most emoji blocks
        (cp >= 0x2600 && cp <= 0x27BF);       // Misc Symbols & Dingbats (some render as emoji)
      if (isLikelyEmojiTarget) {
        // If something slips in, silently coerce a safe fallback.
        // You can override individually later if desired.
        m.set(src, '?');
        m.set(UnicodeMapper.stripEmojiModifiers(src), '?');
        continue;
      }

      m.set(src, dst);
      const stripped = UnicodeMapper.stripEmojiModifiers(src);
      if (stripped !== src) m.set(stripped, dst);
    }
    return m;
  }

  private static readonly emojiMap: Map<string, string> = UnicodeMapper.buildMap();

  /** Remove variation selectors, ZWJ, and skin tones */
  private static stripEmojiModifiers(s: string): string {
    return s.replace(UnicodeMapper.STRIP_REGEX, '');
  }

  static convertEmoji(emoji: string): string {
    return this.emojiMap.get(emoji) || emoji;
  }

  /** Convert text containing emojis to Unicode equivalents */
  static convertText(text: string): string {
    if (!text) return text;

    // Normalize keycaps and strip modifiers for easier matching
    let t = text.replace(this.KEYCAP_REGEX, '$1');
    t = t.replace(this.STRIP_REGEX, '');

    // Fast path: replace all mapped emojis via split/join (avoids regex pitfalls)
    for (const [emoji, unicode] of this.emojiMap.entries()) {
      if (!emoji) continue;
      if (t.includes(emoji)) {
        t = t.split(emoji).join(unicode);
      }
    }
    return t;
  }
  

  /** Check if character (emoji) has a mapping */
  static hasMappingFor(character: string): boolean {
    const stripped = this.stripEmojiModifiers(character);
    return this.emojiMap.has(character) || this.emojiMap.has(stripped);
  }

  /** Simple coverage report for a string: which emojis were mapped, which were missed */
  static coverageReport(text: string): { mapped: Set<string>; missed: Set<string> } {
    const mapped = new Set<string>();
    const missed = new Set<string>();

    // Extract code points; naive emoji segmentation is OK for reporting
    for (const ch of Array.from(text)) {
      const stripped = this.stripEmojiModifiers(ch);
      if (this.emojiMap.has(ch) || this.emojiMap.has(stripped)) {
        mapped.add(ch);
      } else if (/\p{Extended_Pictographic}/u.test(ch)) {
        missed.add(ch);
      }
    }
    return { mapped, missed };
  }
}